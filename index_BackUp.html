<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">

    <title>Tree Example</title>

    <style>

        .node {
            cursor: pointer;
        }

        .node circle {
            fill: #fff;
            stroke: steelblue;
            stroke-width: 3px;
        }

        .node text {
            font: 12px sans-serif;
        }

        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 2px;
        }

    </style>
    <div id="grid"></div>

</head>

<body>

<!--&lt;!&ndash; load the d3.js library &ndash;&gt;-->
<!--<script src="https://d3js.org/d3.v4.min.js"></script>-->

<!-- load the d3.js library -->
<script src="http://d3js.org/d3.v3.min.js"></script>


<!-- load the grid.js  -->
<script src="grid.js" type="text/javascript"></script>

<!-- GLobal utilities variables  -->
<script>
    /*-- tooltip variables  --*/
    const tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("font-size",  12 + "px")
        .style("opacity", 0);
</script>

<script>

    var treeData = [
        {
            "parent":null,
            "children":[
                {
                    "parent":"Root",
                    "children":[
                        {
                            "parent":"state0",
                            "children":[
                                {
                                    "parent":"state1",
                                    "children":[
                                        {
                                            "parent":"state6",
                                            "children":[
                                                {
                                                    "parent":"state11",
                                                    "name":"state16",
                                                    "stateMap":[
                                                        ["wall","wall","wall","wall","wall"],
                                                        ["wall","goal","empty","empty","wall"],
                                                        ["wall","empty","empty","empty","wall"],
                                                        ["wall","key","empty","nokey","wall"],
                                                        ["wall","wall","wall","wall","wall"]
                                                    ]
                                                },
                                                {
                                                    "parent":"state11",
                                                    "children":[
                                                        {
                                                            "parent":"state17",
                                                            "name":"state41",
                                                            "stateMap":[
                                                                ["wall","wall","wall","wall","wall"],
                                                                ["wall","goal","empty","empty","wall"],
                                                                ["wall","empty","empty","empty","wall"],
                                                                ["wall","key","empty","nokey","wall"],
                                                                ["wall","wall","wall","wall","wall"]
                                                            ]
                                                        },
                                                        {
                                                            "parent":"state17",
                                                            "name":"state42",
                                                            "stateMap":[
                                                                ["wall","wall","wall","wall","wall"],
                                                                ["wall","goal","empty","empty","wall"],
                                                                ["wall","empty","empty","empty","wall"],
                                                                ["wall","key","empty","nokey","wall"],
                                                                ["wall","wall","wall","wall","wall"]
                                                            ]
                                                        },
                                                        {
                                                            "parent":"state17",
                                                            "name":"state43",
                                                            "stateMap":[
                                                                ["wall","wall","wall","wall","wall"],
                                                                ["wall","goal","empty","empty","wall"],
                                                                ["wall","empty","empty","empty","wall"],
                                                                ["wall","key","empty","nokey","wall"],
                                                                ["wall","wall","wall","wall","wall"]
                                                            ]
                                                        },
                                                        {
                                                            "parent":"state17",
                                                            "name":"state44",
                                                            "stateMap":[
                                                                ["wall","wall","wall","wall","wall"],
                                                                ["wall","goal","empty","empty","wall"],
                                                                ["wall","empty","empty","empty","wall"],
                                                                ["wall","key","empty","nokey","wall"],
                                                                ["wall","wall","wall","wall","wall"]
                                                            ]
                                                        },
                                                        {
                                                            "parent":"state17",
                                                            "name":"state45",
                                                            "stateMap":[
                                                                ["wall","wall","wall","wall","wall"],
                                                                ["wall","goal","empty","empty","wall"],
                                                                ["wall","empty","empty","empty","wall"],
                                                                ["wall","key","empty","nokey","wall"],
                                                                ["wall","wall","wall","wall","wall"]
                                                            ]
                                                        }
                                                    ],
                                                    "name":"state17",
                                                    "stateMap":[
                                                        ["wall","wall","wall","wall","wall"],
                                                        ["wall","goal","empty","empty","wall"],
                                                        ["wall","empty","empty","empty","wall"],
                                                        ["wall","key","empty","nokey","wall"],
                                                        ["wall","wall","wall","wall","wall"]
                                                    ]
                                                },
                                                {
                                                    "parent":"state11",
                                                    "name":"state18",
                                                    "stateMap":[
                                                        ["wall","wall","wall","wall","wall"],
                                                        ["wall","goal","empty","empty","wall"],
                                                        ["wall","empty","empty","empty","wall"],
                                                        ["wall","key","empty","nokey","wall"],
                                                        ["wall","wall","wall","wall","wall"]
                                                    ]
                                                },
                                                {
                                                    "parent":"state11",
                                                    "name":"state19",
                                                    "stateMap":[
                                                        ["wall","wall","wall","wall","wall"],
                                                        ["wall","goal","empty","empty","wall"],
                                                        ["wall","empty","empty","empty","wall"],
                                                        ["wall","key","empty","nokey","wall"],
                                                        ["wall","wall","wall","wall","wall"]
                                                    ]
                                                },
                                                {
                                                    "parent":"state11",
                                                    "name":"state20",
                                                    "stateMap":[
                                                        ["wall","wall","wall","wall","wall"],
                                                        ["wall","goal","empty","empty","wall"],
                                                        ["wall","empty","empty","empty","wall"],
                                                        ["wall","key","empty","nokey","wall"],
                                                        ["wall","wall","wall","wall","wall"]
                                                    ]
                                                }
                                            ],
                                            "name":"state11",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state6",
                                            "name":"state12",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]

                                            ]
                                        },
                                        {
                                            "parent":"state6",
                                            "name":"state13",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state6",
                                            "name":"state14",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state6",
                                            "name":"state15",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        }
                                    ],
                                    "name":"state6",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state1",
                                    "name":"state7",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state1",
                                    "name":"state8",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state1",
                                    "children":[
                                        {
                                            "parent":"state9",
                                            "name":"state46",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state9",
                                            "name":"state47",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state9",
                                            "name":"state48",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state9",
                                            "name":"state49",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state9",
                                            "name":"state50",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        }
                                    ],
                                    "name":"state9",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state1",
                                    "name":"state10",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                }
                            ],
                            "name":"state1",
                            "stateMap":[
                                ["wall","wall","wall","wall","wall"],
                                ["wall","goal","empty","empty","wall"],
                                ["wall","empty","empty","empty","wall"],
                                ["wall","key","empty","nokey","wall"],
                                ["wall","wall","wall","wall","wall"]
                            ]
                        },
                        {
                            "parent":"state0",
                            "name":"state2",
                            "stateMap":[
                                ["wall","wall","wall","wall","wall"],
                                ["wall","goal","empty","empty","wall"],
                                ["wall","empty","empty","empty","wall"],
                                ["wall","key","empty","nokey","wall"],
                                ["wall","wall","wall","wall","wall"]
                            ]
                        },
                        {
                            "parent":"state0",
                            "children":[
                                {
                                    "parent":"state3",
                                    "name":"state26",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state3",
                                    "name":"state27",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state3",
                                    "name":"state28",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state3",
                                    "name":"state29",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state3",
                                    "children":[
                                        {
                                            "parent":"state30",
                                            "name":"state36",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state30",
                                            "name":"state37",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state30",
                                            "name":"state38",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state30",
                                            "name":"state39",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state30",
                                            "name":"state40",
                                            "stateMap":[
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        }
                                    ],
                                    "name":"state30",
                                    "stateMap":[
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                }
                            ],
                            "name":"state3",
                            "stateMap":[
                                ["wall","wall","wall","wall","wall"],
                                ["wall","goal","empty","empty","wall"],
                                ["wall","empty","empty","empty","wall"],
                                ["wall","key","empty","nokey","wall"],
                                ["wall","wall","wall","wall","wall"]
                            ]
                        },
                        {
                            "parent":"state0",
                            "name":"state4",
                            "stateMap":  [
                                ["wall","wall","wall","wall","wall"],
                                ["wall","goal","empty","empty","wall"],
                                ["wall","empty","empty","empty","wall"],
                                ["wall","key","empty","nokey","wall"],
                                ["wall","wall","wall","wall","wall"]
                            ]
                        },
                        {
                            "parent":"state0",
                            "children":[
                                {
                                    "parent":"state5",
                                    "name":"state21",
                                    "stateMap":  [
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state5",
                                    "name":"state22",
                                    "stateMap":  [
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state5",
                                    "name":"state23",
                                    "stateMap":  [
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state5",
                                    "name":"state24",
                                    "stateMap":  [
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                },
                                {
                                    "parent":"state5",
                                    "children":[
                                        {
                                            "parent":"state25",
                                            "name":"state31",
                                            "stateMap":  [
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state25",
                                            "name":"state32",
                                            "stateMap":  [
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state25",
                                            "name":"state33",
                                            "stateMap":  [
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state25",
                                            "name":"state34",
                                            "stateMap":  [
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        },
                                        {
                                            "parent":"state25",
                                            "name":"state35",
                                            "stateMap":  [
                                                ["wall","wall","wall","wall","wall"],
                                                ["wall","goal","empty","empty","wall"],
                                                ["wall","empty","empty","empty","wall"],
                                                ["wall","key","empty","nokey","wall"],
                                                ["wall","wall","wall","wall","wall"]
                                            ]
                                        }
                                    ],
                                    "name":"state25",
                                    "stateMap":  [
                                        ["wall","wall","wall","wall","wall"],
                                        ["wall","goal","empty","empty","wall"],
                                        ["wall","empty","empty","empty","wall"],
                                        ["wall","key","empty","nokey","wall"],
                                        ["wall","wall","wall","wall","wall"]
                                    ]
                                }
                            ],
                            "name":"state5",
                            "stateMap":  [
                                ["wall","wall","wall","wall","wall"],
                                ["wall","goal","empty","empty","wall"],
                                ["wall","empty","empty","empty","wall"],
                                ["wall","key","empty","nokey","wall"],
                                ["wall","wall","wall","wall","wall"]
                            ]
                        }
                    ],
                    "name":"state0",
                    "stateMap":  [
                        ["wall","wall","wall","wall","wall"],
                        ["wall","goal","empty","empty","wall"],
                        ["wall","empty","empty","empty","wall"],
                        ["wall","key","empty","nokey","wall"],
                        ["wall","wall","wall","wall","wall"]
                    ]
                }
            ],
            "name":"Root",
            "stateMap":  [
                ["wall","wall","wall","wall","wall"],
                ["wall","goal","empty","empty","wall"],
                ["wall","empty","empty","empty","wall"],
                ["wall","key","empty","nokey","wall"],
                ["wall","wall","wall","wall","wall"]
            ]
        }
    ];





    // ************** Generate the tree diagram	 *****************
    var margin = {top: 20, right: 120, bottom: 20, left: 120},
        width = 2000 - margin.right - margin.left,
        height = 500 - margin.top - margin.bottom;

    var i = 0,
        duration = 750,
        root;

    var tree = d3.layout.tree()
        .size([height, width]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });



    var svg = d3.select("body").append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    root = treeData[0];
    root.x0 = height / 2;
    root.y0 = 0;

    update(root);

    d3.select(self.frameElement).style("height", "500px");

    function update(source) {

        // Compute the new tree layout.
        var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

        // Normalize for fixed-depth.
        nodes.forEach(function(d) { d.y = d.depth * 180; });

        // Update the nodes…
        var node = svg.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

        // Enter any new nodes at the parent's previous position.
        var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) { return "translate(" + source.y0 + "," + source.x0 + ")"; })
            .on("mouseover", function(d) {
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .8);
                tooltip.html(

                    console.log('d.stateMap',d.stateMap)

                ).style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 38) + "px");
            })
            .on("mouseout", function(d) {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            })
            .on("click", click);

//
//        nodeEnter.append("circle")
//            .attr("r", 1e-6)
//            .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

        var currentGridData;

        nodeEnter.append("text")
            .attr("x", function(d) { return d.children || d._children ? -13 : 13; })
            .attr("dy", ".35em")
            .attr("text-anchor", function(d) { return d.children || d._children ? "end" : "start"; })
            .text(function(d) {

                console.log(d.stateMap);
                currentGridData = getGridData(d.stateMap);

                return d.name; })
            .style("fill-opacity", 1e-6);




        var thisGrid = nodeEnter
            .append("svg")
            .attr("class", "grid_svg")
            .attr("preserveAspectRatio", "xMinYMin meet")
            .attr("viewBox", "0 0 300 300")
            .attr("x", -10)
            .attr("y", -10)
            .attr("height", 25)
            .attr("width", 25)
            .on( 'mouseenter', function() {
                // select element in current context
                d3.select( this )
                    .transition()
                    .attr("height", 150)
                    .attr("width", 150);
            })
            // set back
            .on( 'mouseleave', function() {
                d3.select( this )
                    .transition()
                    .attr("height", 25)
                    .attr("width", 25);
            });

        var row = thisGrid.selectAll(".row")
            .data(gridData)
            .enter().append("g")
            .attr("class", "row");


        var cell = row.selectAll(".cell")
            .data(function(d) { return d; })
            .enter().append("svg:g")
            .attr("class", "cell");



        var column = cell.append("rect")
            .attr("class","square")
            .attr("x", function(d) { return d.x; })
            .attr("y", function(d) { return d.y; })
            .attr("width", function(d) { return d.width; })
            .attr("height", function(d) { return d.height; })
            .style("fill",  function(d) { return   "url(#grump_avatar" + d.id + ")" ; })
            .style("stroke", "#222")
            .text(function(d) { return d.imgStr; });


        var   defs = cell.append('svg:defs');



        defs.append("svg:pattern")
            .attr("id",  function(d) { return   "grump_avatar" + d.id ; })
            .attr("width", config.avatar_size)
            .attr("height", config.avatar_size)
            .attr("patternUnits", "userSpaceOnUse");

        cell.append("svg:image")
            .attr("xlink:href",  function(d) { return  'images/sprites/' + d.imgStr + '.png'; } )
            .attr("width", config.avatar_size)
            .attr("height", config.avatar_size)
            .attr("x", function(d) { return d.x; })
            .attr("y", function(d) { return d.y; });




        // Transition nodes to their new position.
        var nodeUpdate = node.transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

        nodeUpdate.select("circle")
            .attr("r", 10)
            .style("fill", function(d) { return d._children ? "lightsteelblue" : "#fff"; });

        nodeUpdate.select("text")
            .style("fill-opacity", 1);

        // Transition exiting nodes to the parent's new position.
        var nodeExit = node.exit().transition()
            .duration(duration)
            .attr("transform", function(d) { return "translate(" + source.y + "," + source.x + ")"; })
            .remove();

        nodeExit.select("circle")
            .attr("r", 1e-6);

        nodeExit.select("text")
            .style("fill-opacity", 1e-6);

        // Update the links…
        var link = svg.selectAll("path.link")
            .data(links, function(d) { return d.target.id; });

        // Enter any new links at the parent's previous position.
        link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", function(d) {
                var o = {x: source.x0, y: source.y0};
                return diagonal({source: o, target: o});
            });

        // Transition links to their new position.
        link.transition()
            .duration(duration)
            .attr("d", diagonal);

        // Transition exiting nodes to the parent's new position.
        link.exit().transition()
            .duration(duration)
            .attr("d", function(d) {
                var o = {x: source.x, y: source.y};
                return diagonal({source: o, target: o});
            })
            .remove();

        // Stash the old positions for transition.
        nodes.forEach(function(d) {
            d.x0 = d.x;
            d.y0 = d.y;
        });
    }

    // Toggle children on click.
    function click(d) {
        if (d.children) {
            d._children = d.children;
            d.children = null;
        } else {
            d.children = d._children;
            d._children = null;
        }
        update(d);
    }

</script>

</body>
</html>
